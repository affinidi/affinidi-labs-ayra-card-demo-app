# Issuer Portal - Verifiable Credential Issuance Service

The Issuer Portal is a Dart-based server implementing the Verifiable Data Issuance Protocol (VDIP) for issuing employment credentials and Ayra business cards. It provides DID:web identifier generation and credential lifecycle management.

## ğŸ“– Table of Contents
- [Overview](#-overview)
- [Architecture](#%EF%B8%8F-architecture)
- [Structure](#-structure)
- [Setup Process](#-setup-process)
- [Configuration](#-configuration)
- [Usage](#-usage)
- [Development](#-development)
- [Monitoring](#-monitoring)
- [Advanced Configuration](#-advanced-configuration)

## ğŸ“‹ Overview

This service acts as the credential issuing authority in the Ayra ecosystem, enabling organizations to:

- Generate and manage DID:web identifiers for organizations
- Issue employment credentials to employees
- Issue Ayra business card credentials with customization
- Integrate with Trust Registry for trusted issuance
- Communicate with mobile wallet apps via DIDComm

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Mobile App    â”‚
â”‚   (Wallet)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ VDIP
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Issuer Portal   â”‚
â”‚  (Dart Server)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DIDComm         â”‚
â”‚ Mediator        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ Structure

```
issuer-portal/
â”œâ”€â”€ setup.sh              # Setup and configuration script
â”œâ”€â”€ docker-compose.yml    # Docker container configuration
â””â”€â”€ code/                 # Issuer portal code (included in repository)
    â”œâ”€â”€ bin/              # Dart executable
    â”œâ”€â”€ lib/              # Source code
    â”œâ”€â”€ .env              # Environment configuration (generated by setup)
    â””â”€â”€ pubspec.yaml      # Dart dependencies
```

## ğŸš€ Setup Process

### Automatic Setup (Recommended)

Run from project root:

```bash
./setup-ayra.sh
```

This will automatically:

1. Run issuer-portal setup script
2. Verify the issuer code is present
3. Configure environment variables
4. Update DID:web domains
5. Prepare for Docker deployment

### Manual Setup

```bash
cd issuer-portal
./setup.sh
```

### What the Setup Does

1. **Verify Code**: Confirms issuer portal code is present in `code/` directory
2. **Environment Configuration**: Creates `.env` file with:
   - SERVICE_DID (Meetingplace control plane)
   - MEDIATOR_DID (DIDComm mediator)
   - Organization DID:web domains
   - Trust Registry endpoints
   - Storage backend settings
3. **Domain Assignment**: Updates issuer domains from `domains.json`
4. **Dependency Preparation**: Sets up for Dart package installation

## ğŸ”§ Configuration

### Environment Variables

Located in `code/.env` (auto-generated):

```bash
# Affinidi Services
SERVICE_DID=did:web:example.com:service
MEDIATOR_DID=did:web:example.com:mediator
MEDIATOR_DOMAIN=https://mediator.example.com

# Organization DIDs (auto-configured from ngrok)
ISSUER_DIDWEB_DOMAIN=abc123.ngrok-free.app/sweetlane-bank
ECOSYSTEM_DIDWEB_DOMAIN=abc123.ngrok-free.app/sweetlane-group
AYRA_DIDWEB_DOMAIN=abc123.ngrok-free.app/ayra-forum

# Trust Registry
TR_API_ENDPOINT=https://ghi789.ngrok-free.app

# Email Configuration
ALLOWED_EMAIL_DOMAIN=sweetlane-bank,affinidi

# Storage
ISS_STORAGE_BACKEND=file
ISS_REDIS_HOST=localhost
ISS_REDIS_PORT=6379
ISS_REDIS_SECURE=false
```

### Docker Configuration

Located in `docker-compose.yml`:

```yaml
services:
  issuer-portal:
    build:
      context: ./code
      dockerfile: Dockerfile
    container_name: issuer-portal
    ports:
      - "8080:8080"
    env_file:
      - ./code/.env
    networks:
      - ayra-network
    restart: unless-stopped
```

## ğŸ® Usage

### Starting the Service

```bash
# From project root
docker compose up -d issuer-portal

# Check logs
docker compose logs -f issuer-portal
```

### Testing the Service

```bash
# Health check
curl https://your-issuer-domain.ngrok-free.app/health

# Get organization DID document
curl https://your-issuer-domain.ngrok-free.app/sweetlane-bank/did.json

# Get ecosystem DID document
curl https://your-issuer-domain.ngrok-free.app/sweetlane-group/did.json

# Get governance framework DID document
curl https://your-issuer-domain.ngrok-free.app/ayra-forum/did.json


# POST Login endpoint - authenticates(mock) and return OOB Url
curl --location 'https:///your-issuer-domain.ngrok-free.app/sweetlane-bank/api/login' \
--header 'Content-Type: application/json' \
--data-raw '{
   "email": "paramesh@affinidi.com"
}'

-- Response
{
  "ok": true,
  "email": "paramesh@affinidi.com",
  "oobUrl": "https://1e6bd197-d47f-4170-b944-e0ad7bf659f2.mpx.dev.affinidi.io/v1/get-oob/b4ba91d6-107e-4b34-90e5-5eff6c30dc7c",
  "did": "did:key:zDnaeSqXgwLmWULRKpLYUpnm9jpi3XMBNskvTfwBCEmTaZbtP"
}
```

## ğŸ› ï¸ Development

### Building Locally

```bash
cd code

# Install dependencies
dart pub get

# Run development server
dart run bin/server.dart
```

### Testing

```bash
# Run tests
dart test

# Run with coverage
dart test --coverage=coverage

# Format code
dart format .

# Analyze code
dart analyze
```

### Debugging

```bash
# Enable verbose logging
export LOG_LEVEL=debug
dart run bin/server.dart

# Watch logs
docker compose logs -f issuer-portal
```

## ğŸ“Š Monitoring

### Health Endpoint

```bash
curl https://your-issuer-domain.ngrok-free.app/health
```

## ğŸš€ Advanced Configuration

### Using Redis for Storage

```bash
# In .env
ISS_STORAGE_BACKEND=redis
ISS_REDIS_HOST=redis
ISS_REDIS_PORT=6379
ISS_REDIS_SECURE=false
```

### Custom Email Domains

```bash
# Allow multiple domains for employee verification
ALLOWED_EMAIL_DOMAIN=sweetlane-bank,affinidi,example-corp
```

**Note:** Keep ngrok tunnels running for DID resolution and credential issuance to work properly!
