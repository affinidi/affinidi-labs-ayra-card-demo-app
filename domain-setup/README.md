# Domain Setup - ngrok Tunnel Manager

This component manages public domain generation using ngrok tunnels for the Ayra ecosystem services. It automatically creates tunnels for the Issuer Portal, Verifier Portal, and Trust Registry UI, making them accessible via public HTTPS URLs.

## ğŸ“‹ Overview

The domain setup automates the creation and management of ngrok tunnels, which provide public access to locally-running services. This is essential for:

- Mobile app connectivity to backend services
- Public credential verification flows
- Cross-device testing and demonstration
- Webhook endpoints for external services

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ngrok Cloud    â”‚
â”‚   (Public URLs)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚  ngrok   â”‚
    â”‚ Tunnels  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Local Services                 â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  â€¢ Issuer Portal (8080)         â”‚
    â”‚  â€¢ Verifier Portal (8081)       â”‚
    â”‚  â€¢ Trust Registry UI (3001)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ Structure

```
domain-setup/
â”œâ”€â”€ setup.sh              # Main setup script
â””â”€â”€ code/
    â”œâ”€â”€ package.json      # Node.js dependencies
    â”œâ”€â”€ server.js         # Tunnel server (creates 3 tunnels)
    â”œâ”€â”€ generate.js       # One-time tunnel generator
    â””â”€â”€ domains.json      # Generated tunnel URLs (created by scripts)
```

## ğŸš€ Setup Process

### Automatic Setup (Recommended)

The domain setup is automatically executed when you run the main setup script:

```bash
# From project root
./setup-ayra.sh
```

### Manual Setup

If you need to run domain setup independently:

```bash
cd domain-setup
./setup.sh
```

### What Happens During Setup

1. **Dependency Installation**: Installs `@ngrok/ngrok` and `dotenv` packages
2. **Tunnel Creation**: Opens a new terminal window running `npm start`
3. **Domain Generation**: Creates 3 ngrok tunnels:
   - `issuer` - For Issuer Portal (port 8080)
   - `verifier` - For Verifier Portal (port 8081)
   - `trustRegistry` - For Trust Registry UI (port 3001)
4. **Configuration File**: Generates `domains.json` with tunnel URLs
5. **Environment Update**: Updates main `.env` file with generated domains

## ğŸ”§ Configuration

### Required Environment Variables

Add to the main `.env` file in project root:

```bash
USE_NGROK=true
NGROK_AUTH_TOKEN=your_ngrok_auth_token_here
```

### Get Your ngrok Auth Token

1. Sign up at [ngrok.com](https://dashboard.ngrok.com/signup)
2. Navigate to [Your Authtoken](https://dashboard.ngrok.com/get-started/your-authtoken)
3. Copy the token
4. Add to `.env` file

## ğŸ“ Generated Files

### domains.json

This file is automatically generated and contains:

```json
{
  "issuer": {
    "domain": "abc123.ngrok-free.app",
    "url": "https://abc123.ngrok-free.app",
    "didweb": {
      "sweetlane_bank": "abc123.ngrok-free.app/sweetlane-bank",
      "sweetlane_group": "abc123.ngrok-free.app/sweetlane-group",
      "ayra_forum": "abc123.ngrok-free.app/ayra-forum"
    }
  },
  "verifier": {
    "domain": "def456.ngrok-free.app",
    "url": "https://def456.ngrok-free.app"
  },
  "trustRegistry": {
    "domain": "ghi789.ngrok-free.app",
    "url": "https://ghi789.ngrok-free.app"
  }
}
```

**Note:** This file is used by other setup scripts to configure services.

## ğŸ® Usage

### Starting Tunnels

Tunnels are automatically started during setup in a new terminal window. This terminal must remain open:

```bash
# Terminal will show:
ğŸš€ Starting ngrok tunnels for Ayra services...

Issuer Portal: https://abc123.ngrok-free.app
Verifier Portal: https://def456.ngrok-free.app
Trust Registry UI: https://ghi789.ngrok-free.app

âœ… All tunnels are running!
ğŸ“ domains.json has been generated

âš ï¸  Keep this terminal open to maintain the tunnels
Press Ctrl+C to stop all tunnels
```

### Stopping Tunnels

Press `Ctrl+C` in the ngrok terminal window to gracefully stop all tunnels.

### Restarting Tunnels

If tunnels are accidentally closed:

```bash
cd domain-setup/code
npm start
```

**Note:** New tunnel URLs will be generated. You'll need to re-run setup scripts to update configurations.

## ğŸ” Available Scripts

### npm start

Runs the tunnel server that creates and maintains 3 simultaneous tunnels:

```bash
cd code
npm start
```

- Creates tunnels for issuer, verifier, and trust registry
- Generates `domains.json` with tunnel information
- Keeps tunnels alive until stopped
- Shows tunnel URLs in console

### npm run generate

One-time tunnel generation (for testing):

```bash
cd code
npm run generate
```

- Creates tunnels and generates `domains.json`
- Exits immediately after generation
- Useful for CI/CD or automated testing

## ğŸ”’ Security Considerations

### ngrok Free Tier Limitations

- Tunnels have randomized URLs that change on restart
- Rate limited connections
- ngrok branding on free URLs
- Not suitable for production use

### Best Practices

1. **Never commit** `domains.json` or auth tokens to version control
2. **Rotate tokens** periodically
3. **Use reserved domains** (paid feature) for stable URLs
4. **Monitor tunnel usage** in ngrok dashboard
5. **Stop tunnels** when not in use to save resources

### Alternative Solutions

For production or stable development:

1. **Cloudflare Tunnel** (cloudflared)
2. **LocalTunnel** (localtunnel.me)
3. **Tailscale** (private networking)
4. **Self-hosted reverse proxy** with static IP

## ğŸ“š Dependencies

- **@ngrok/ngrok** (^1.4.1) - Official ngrok Node.js SDK
- **dotenv** (^16.3.1) - Environment variable management

## ğŸ”— Related Documentation

- [Main Setup Guide](../README.md)
- [ngrok Documentation](https://ngrok.com/docs)
- [ngrok Node.js SDK](https://github.com/ngrok/ngrok-javascript)

## ğŸ’¡ Tips

1. **Keep tunnel terminal visible** during development to monitor status
2. **Bookmark tunnel URLs** for quick access during testing
3. **Use ngrok dashboard** to view tunnel traffic and debug issues
4. **Set up reserved domains** if you need consistent URLs
5. **Test connectivity** after setup with curl or browser

## ğŸš§ Maintenance

### Updating Dependencies

```bash
cd code
npm update
```

### Verifying Setup

```bash
# Check if tunnels are running
curl -I https://your-tunnel-url.ngrok-free.app

# Should return 200 or redirect response
```

### Cleanup

```bash
# Remove generated files
rm code/domains.json
rm -rf code/node_modules

# Stop tunnels (Ctrl+C in tunnel terminal)
```

---

**Remember:** The tunnel terminal must remain open for services to be accessible via public URLs!
