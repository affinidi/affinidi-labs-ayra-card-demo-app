#!/usr/bin/env node

/**
 * Configure Keycloak URLs from ngrok domains
 *
 * This script reads the domains.json file generated by ngrok tunnels
 * and outputs environment variable exports for Keycloak services.
 *
 * Usage:
 *   node configure-keycloak-urls.js          # Print env vars
 *   eval $(node configure-keycloak-urls.js)  # Set env vars in shell
 */

import { readFileSync, existsSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const domainsFile = join(__dirname, 'domains.json');

if (!existsSync(domainsFile)) {
    console.error('# Error: domains.json not found. Run domain-setup first with ENABLE_KEYCLOAK_TUNNELS=true');
    process.exit(1);
}

try {
    const domains = JSON.parse(readFileSync(domainsFile, 'utf-8'));

    if (!domains.keycloak) {
        console.error('# Error: Keycloak tunnels not found in domains.json');
        console.error('# Make sure ENABLE_KEYCLOAK_TUNNELS=true in .env and restart domain-setup');
        process.exit(1);
    }

    const keycloakUrl = domains.keycloak.server?.url;
    const oidcBridgeUrl = domains.keycloak.oidcBridge?.url;
    const demoAppUrl = domains.keycloak.demoApp?.url;

    if (!keycloakUrl || !oidcBridgeUrl || !demoAppUrl) {
        console.error('# Error: Missing Keycloak tunnel URLs in domains.json');
        process.exit(1);
    }

    // Output environment variables for shell export
    console.log('# Keycloak ngrok URLs - Generated from domains.json');
    console.log(`# Generated at: ${domains.generated_at}`);
    console.log('');
    console.log('# Keycloak Server');
    console.log(`export KEYCLOAK_URL="${keycloakUrl}"`);
    console.log('');
    console.log('# OIDC Bridge');
    console.log(`export OIDC_BRIDGE_ISSUER_URL="${oidcBridgeUrl}"`);
    console.log(`export OIDC_BRIDGE_KEYCLOAK_REDIRECT_URI="${keycloakUrl}/realms/ayra-demo/broker/vc-authn/endpoint"`);
    console.log('');
    console.log('# Demo App');
    console.log(`export KEYCLOAK_DEMO_APP_URL="${demoAppUrl}"`);
    console.log('');
    console.log('# To apply these, run:');
    console.log('#   eval $(node domain-setup/code/configure-keycloak-urls.js)');
    console.log('#   docker compose up -d --force-recreate keycloak vc-authn-oidc-bridge keycloak-demo-app');

} catch (error) {
    console.error(`# Error reading domains.json: ${error.message}`);
    process.exit(1);
}
